name: Daily IBM QASM Pipeline

on:
  schedule:
    - cron: "0 3 * * *" # 每天 UTC 03:00 執行
  workflow_dispatch:

jobs:
  ibm-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install qiskit qiskit-ibm-provider numpy

      - name: Generate QASM
        run: python generate_qasm.py

      - name: Submit job to IBM Quantum
        env:
          IBMQ_TOKEN: ${{ secrets.IBMQ_TOKEN }}
        run: |
          echo "import os; os.environ['IBMQ_TOKEN'] = '${{ secrets.IBMQ_TOKEN }}'" >> patch_token.py
          cat submit_ibm_job.py >> patch_token.py
          python patch_token.py for_ibm.qasm

      - name: Wait 45s for job to run
        run: sleep 45

      - name: Fetch result
        run: python fetch_result.py $(cat job_id.txt)

      - name: Analyze result
        run: python auto_decision.py
